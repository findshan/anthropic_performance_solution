# ä¼˜åŒ–æ–¹æ¡ˆ v0.9ï¼ˆä¸­æ–‡ï¼‰

## ç›®æ ‡
- åœ¨ä¿æŒ `tests/submission_tests.py` æ­£ç¡®æ€§çš„å‰æä¸‹ï¼ŒæŠŠ cycles2 æ¨è¿‘ 1200ã€‚
- å½“å‰åŸºçº¿ï¼š`tests/submission_tests.py` çº¦ 2423 cycles2ã€‚

## ç¬¬ä¸€æ€§åŸç†ä¸èµ„æºçº¦æŸ
- æ¯å‘¨æœŸèµ„æºä¸Šé™ï¼š`load x2`ï¼Œ`valu x6`ï¼Œ`flow x1`ã€‚
- å‘¨æœŸç”±æœ€æ…¢å¼•æ“å†³å®šï¼Œå¿…é¡»åŒæ—¶é™ä½ `load` ä¸ `valu`ã€‚
- gather è®¿é—®æ˜¯éè¿ç»­è¯»ï¼Œä¸èƒ½ç”¨ `vload` æ›¿ä»£ï¼Œåªèƒ½è°ƒåº¦æˆ–æ›¿æ¢è·¯å¾„ã€‚

## ç†è®ºä¸‹ç•Œä¸æ•°å­¦æ¨å¯¼
è®¾ `L` ä¸º load æ“ä½œæ•°ï¼Œ`V` ä¸º valu æ“ä½œæ•°ï¼Œ`S` ä¸º store æ“ä½œæ•°ï¼š
```
cycles >= max(ceil(L/2), ceil(V/6), ceil(S/2))
```
å½“å‰ trace ä¼°ç®—ï¼š
- `L â‰ˆ 3165` â†’ `L/2 â‰ˆ 1583`
- `V â‰ˆ 8756` â†’ `V/6 â‰ˆ 1459`
- `S â‰ˆ 64` â†’ `S/2 â‰ˆ 32`

è¾¾åˆ° 1200 çš„å¿…è¦æ¡ä»¶ï¼š
- `L <= 2400`
- `V <= 7200`

## æ ¸å¿ƒç“¶é¢ˆ
- `load_offset` ä»å æ®å¤§é‡å‘¨æœŸï¼Œä¸”æ— æ³•è¢« vload æ›¿ä»£ã€‚
- hash é“¾è·¯çš„ valu æ“ä½œæ•°åé«˜ï¼Œé™åˆ¶äº†ç†è®ºä¸‹ç•Œã€‚
- load ä¸ valu çš„äº¤é”™ä»æœ‰ç©ºæ¡£ï¼Œæœªè¾¾åˆ°æ»¡è½½åˆ©ç”¨ç‡ã€‚

## æœ¬æ¬¡ä¼˜åŒ–è¦è§£å†³çš„é—®é¢˜
- è¿›ä¸€æ­¥å‰Šå‡ `load_offset` ä½¿ç”¨æ¬¡æ•°ã€‚
- ç”¨æ›´ä½çš„ valu ä»£ä»·å®Œæˆ hashã€‚
- æŠŠ `flow` å¼•æ“å¼•å…¥æ·±åº¦ç‰¹åŒ–è·¯å¾„ï¼Œå¹³è¡¡å„å¼•æ“è´Ÿè½½ã€‚

## ç³»ç»Ÿæ¶æ„å›¾
```mermaid
flowchart TB
  Core["Core"]
  Scratch["Scratch"]
  Engines["Engines"]
  Mem["Mem"]
  Core --> Scratch
  Core --> Engines
  Engines --> Scratch
  Engines --> Mem
```

## æµç¨‹å›¾
```mermaid
flowchart LR
  Init["Init"] --> Load["Load"]
  Load --> Round["RoundLoop"]
  Round --> Node["NodeVal"]
  Node --> Hash["Hash"]
  Hash --> Idx["IdxUpdate"]
  Idx --> Round
  Round --> Store["Store"]
```

## æ—¶åºå›¾
```mermaid
sequenceDiagram
  participant KB as KernelBuilder
  participant MA as Machine
  participant RF as Reference
  KB->>MA: build
  MA->>MA: run
  RF-->>MA: compare
  MA-->>KB: cycles
```

## æ•°æ®æµç¨‹å›¾
```mermaid
flowchart LR
  Inp["Input"] --> Buf["Scratch\nBuffers"]
  Buf --> Node["NodeVal"]
  Node --> Hash["Hash"]
  Hash --> Idx["Idx"]
  Idx --> Buf
  Buf --> Out["Output"]
```

## é¥¼å›¾
```mermaid
pie title ops_mix
  "valu" : 8756
  "load" : 3165
  "store" : 64
  "alu" : 98
```

## ä¼˜åŒ–ç‚¹

### 1) æ·±åº¦ 2 å’Œæ·±åº¦ 3 çš„ vselect é€‰æ‹©æ ‘
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šç”¨ `flow.vselect` ç»„åˆé¢„åŠ è½½èŠ‚ç‚¹å€¼ï¼Œå‡å°‘ `load_offset`ã€‚
- æ­¥éª¤ï¼š
  1. é¢„åŠ è½½ depth2 çš„ 4 ä¸ªèŠ‚ç‚¹å’Œ depth3 çš„ 8 ä¸ªèŠ‚ç‚¹ã€‚
  2. è®¡ç®— `bit0 bit1 bit2` ä½œä¸º vselect æ¡ä»¶ã€‚
  3. ç”¨ vselect é€‰æ‹©æ ‘ç”Ÿæˆ node_valã€‚
  4. è¯¥è½®æ¬¡ç¦ç”¨ gatherã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart LR
  subgraph Before["Before\nGather"]
    B1["LoadOffset"] --> B2["NodeVal"]
  end
  subgraph After["After\nSelectTree"]
    A1["Vselect"] --> A2["NodeVal"]
  end
```
- é¢„æœŸæ”¶ç›Šï¼š`load_offset` é™ 800 åˆ° 1000ï¼ŒL ä¸‹ç•Œå¯æ¥è¿‘ 1200ã€‚

### 2) Hash åˆ†æ®µ LUT å‹ç¼©
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šæŠŠ hash é“¾è·¯æ‹†ä¸ºå°å‹ LUT å’Œä½æˆæœ¬åˆå¹¶ï¼Œå‡å°‘ valu æ“ä½œæ•°ã€‚
- æ­¥éª¤ï¼š
  1. é€‰æ‹© 8 æˆ– 12 bit LUT ç²’åº¦ã€‚
  2. ç”¨ LUT è¦†ç›–å¤šé˜¶æ®µç»„åˆï¼Œå‡å°‘ 2 åˆ° 3 ä¸ª hash stageã€‚
  3. ç”¨å°‘é‡ add xor åˆå¹¶æ®µç»“æœã€‚
  4. è¯„ä¼° LUT load æˆæœ¬ä¸ valu å‡å°‘çš„æ”¶ç›Šã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart LR
  subgraph Before["Before\nHashStages"]
    B1["Stage1"] --> B2["Stage2"] --> B3["Stage3"]
  end
  subgraph After["After\nHashLut"]
    A1["Lut"] --> A2["Merge"]
  end
```
- é¢„æœŸæ”¶ç›Šï¼švalu é™ 20 åˆ° 30 ç™¾åˆ†æ¯”ï¼ŒV ä¸‹ç•Œæ¥è¿‘ 1200ã€‚

### 3) è´Ÿè½½æ’å…¥èŠ‚å¥ä¼˜åŒ–
- ä¼˜å…ˆçº§ï¼šğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šå°† gather è´Ÿè½½æ›´å‡åŒ€åœ°åˆ†å¸ƒåˆ° hash è®¡ç®—ä¹‹é—´ï¼Œå‡å°‘ç©ºæ¡£ã€‚
- æ­¥éª¤ï¼š
  1. ç»Ÿè®¡æ¯è½®å¯æ’å…¥ç‚¹ã€‚
  2. å°† `load_offset` åˆ†ç‰‡æ’å…¥ã€‚
  3. ä¿æŒä¾èµ–ä¸å˜ï¼Œè§‚å¯Ÿ load ä¸ valu åˆ©ç”¨ç‡ã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart TB
  subgraph Before["Before\nBurst"]
    B1["LoadBurst"] --> B2["HashBlock"]
  end
  subgraph After["After\nSliced"]
    A1["LoadSlice"] --> A2["Hash"]
    A2 --> A3["LoadSlice"]
    A3 --> A4["Hash"]
  end
```
- é¢„æœŸæ”¶ç›Šï¼šå‡å°‘ç©ºè½¬å‘¨æœŸï¼ŒæŠŠæ€» cycles é€¼è¿‘ç†è®ºä¸‹ç•Œã€‚

## ä»£ç è‰æ¡ˆ
```python
# depth2 vselect sketch
offset = idx - 3
b0 = offset & 1
b1 = (offset >> 1) & 1
t0 = vselect(b0, v1, v0)
t1 = vselect(b0, v3, v2)
node = vselect(b1, t1, t0)

# hash lut sketch
hi = (val >> 12) & 0xFFF
lo = val & 0xFFF
val = lut_hi[hi] ^ lut_lo[lo]
```

## æ ¡éªŒ
- `python tests/submission_tests.py` å¿…é¡»é€šè¿‡ã€‚
- trace ä¸­ `load_offset` ä¸ `valu` æ€»é‡ä¸‹é™ï¼Œutil æ¥è¿‘ 80 ä»¥ä¸Šã€‚

## é£é™©ä¸ç¼“è§£
- LUT ç­‰ä»·æ€§é£é™©ï¼šé€è½®å¯¹æ¯” `reference_kernel2`ã€‚
- vselect è¿‡å¤šå¯¼è‡´ flow æˆä¸ºç“¶é¢ˆï¼šé™åˆ¶åªåœ¨ depth2 3 ä½¿ç”¨ã€‚
- scratch å‹åŠ›ä¸Šå‡ï¼šæŒ‰éœ€åŠ è½½ LUT æˆ–é‡‡ç”¨åˆ†å—ã€‚

