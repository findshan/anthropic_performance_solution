# ä¼˜åŒ–æ–¹æ¡ˆ v0.8ï¼ˆä¸­æ–‡ï¼‰

## ç›®æ ‡
- åœ¨ä¿æŒ `tests/submission_tests.py` æ­£ç¡®æ€§çš„å‰æä¸‹ï¼Œç»§ç»­å‹ç¼© cycles2ã€‚
- ç›®æ ‡è¶‹è¿‘ 1200ã€‚å½“å‰åŸºçº¿çº¦ 2423 cycles2ã€‚

## ç¬¬ä¸€æ€§åŸç†ä¸èµ„æºçº¦æŸ
- æŒ‡ä»¤å¹¶è¡Œï¼šæ¯å‘¨æœŸæœ€å¤š `load x2`ã€`valu x6`ï¼Œå†™å›åœ¨å‘¨æœŸæœ«ç”Ÿæ•ˆã€‚
- ååä¸Šé™ï¼šæœ€ç»ˆå‘¨æœŸå— `max(L/2, V/6)` çº¦æŸï¼Œè°ƒåº¦åªèƒ½é€¼è¿‘ä¸‹ç•Œï¼Œä¸èƒ½çªç ´ã€‚
- è®¿é—®çº¦æŸï¼šæ ‘èŠ‚ç‚¹è®¿é—®ä¸ºéšæœº gatherï¼Œæ— æ³•é€šè¿‡ vload å®ç°å…¨è¿ç»­è¯»å–ã€‚
- æ­£ç¡®æ€§çº¦æŸï¼šè¾“å‡ºå¿…é¡»ä¸ `reference_kernel2` ä¸€è‡´ï¼Œ`tests/` ä¸å¯ä¿®æ”¹ã€‚

## ç†è®ºä¸‹ç•Œä¸æ•°å­¦æ¨å¯¼
ä»¤ `L` ä¸º load æ“ä½œæ•°ï¼Œ`V` ä¸º valu æ“ä½œæ•°ï¼Œ`S` ä¸º store æ“ä½œæ•°ï¼š
```
cycles >= max(ceil(L/2), ceil(V/6), ceil(S/2))
```
å½“å‰ traceï¼š
- `L â‰ˆ 3165`ï¼Œ`V â‰ˆ 8756`ï¼Œ`S â‰ˆ 64`
- ä¸‹ç•Œçº¦ `max(1583, 1459, 32) = 1583`

è¦è¾¾åˆ° 1200ï¼Œéœ€è¦åŒæ—¶æ»¡è¶³ï¼š
- `L <= 2400`
- `V <= 7200`

å› æ­¤æœ¬è½®ç­–ç•¥æ˜¯ï¼šå‡å°‘æ— æ•ˆ wrap è¿ç®—ï¼Œæ”¶ç¼© V çš„â€œå›ºå®šæˆæœ¬â€ï¼Œä¸ºåç»­æ·±åº¦ç‰¹åŒ–å’Œ hash å‹ç¼©è…¾å‡ºé¢„ç®—ã€‚

## æ ¸å¿ƒç“¶é¢ˆ
- `load_offset` ä»æ˜¯ä¸»è¦ load çƒ­ç‚¹ã€‚
- idx wrap åœ¨éæœ€æ·±è½®æ¬¡ä»æ‰§è¡Œï¼Œé€ æˆä¸å¿…è¦çš„ valu æ¶ˆè€—ã€‚
- hash é“¾è·¯å ç”¨å›ºå®š 6 é˜¶æ®µï¼Œvalu æ“ä½œæ•°ä»é«˜ã€‚

## æœ¬æ¬¡ä¼˜åŒ–è¦è§£å†³çš„é—®é¢˜
- ç§»é™¤éæœ€æ·±è½®æ¬¡çš„ wrap æ¯”è¾ƒä¸ä¹˜æ³•ã€‚
- åœ¨ root è½®æ¬¡ç®€åŒ– idx æ›´æ–°è·¯å¾„ã€‚
- å»ºç«‹ 1200 cycles è·¯çº¿å›¾çš„æ•°å­¦çº¦æŸä¸ä¸‹ä¸€æ­¥è½ç‚¹ã€‚

## ç³»ç»Ÿæ¶æ„å›¾
```mermaid
flowchart TB
  Core[Core]
  Scratch[Scratch]
  Engines[Engines]
  Mem[Mem]
  Core --> Scratch
  Core --> Engines
  Engines --> Scratch
  Engines --> Mem
```

## æµç¨‹å›¾
```mermaid
flowchart LR
  Init[Init] --> Load[Load]
  Load --> RoundLoop[RoundLoop]
  RoundLoop --> Node[Node]
  Node --> Hash[Hash]
  Hash --> Idx[IdxUpdate]
  Idx --> RoundLoop
  RoundLoop --> Store[Store]
```

## æ—¶åºå›¾
```mermaid
sequenceDiagram
  participant KB as KernelBuilder
  participant MA as Machine
  participant RF as Reference
  KB->>MA: build
  MA->>MA: run
  RF-->>MA: compare
  MA-->>KB: cycles
```

## æ•°æ®æµç¨‹å›¾
```mermaid
flowchart LR
  Inp[Input] --> Buf[ScratchBuf]
  Buf --> Node[NodeVal]
  Node --> Hash[Hash]
  Hash --> Idx[Idx]
  Idx --> Buf
  Buf --> Out[Output]
```

## é¥¼å›¾
```mermaid
pie title ops_mix
  "valu" : 8756
  "load" : 3165
  "store" : 64
  "alu" : 98
```

## ä¼˜åŒ–ç‚¹

### 1) æ·±åº¦æ„ŸçŸ¥çš„ wrap æ¶ˆé™¤
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šåªæœ‰ depth ç­‰äº forest_height æ—¶æ‰å¯èƒ½è¶Šç•Œï¼Œå…¶ä»–è½®æ¬¡æ— éœ€ wrapã€‚
- æ­¥éª¤ï¼š
  1. è®¡ç®— `depth = round_i % (forest_height + 1)`ã€‚
  2. å½“ `depth != forest_height` æ—¶è·³è¿‡ `< n_nodes` ä¸ `*`ã€‚
  3. depth ä¸º 0 çš„è½®æ¬¡ç›´æ¥ç”¨ `idx = parity + 1`ã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart LR
  subgraph Before[WrapAll]
    B1[Compare] --> B2[Mul]
  end
  subgraph After[WrapDepth10]
    A1[Compare] --> A2[Mul]
  end
```
- é¢„æœŸæ”¶ç›Šï¼švalu å‡å°‘çº¦ 1024 opsï¼Œcycles ä» 2525 é™è‡³ 2423ã€‚

### 2) æ·±åº¦ 2 ä¸ 3 é¢„åŠ è½½é€‰æ‹©æ ‘
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šæå‰åŠ è½½ depth2 çš„ 4 èŠ‚ç‚¹ä¸ depth3 çš„ 8 èŠ‚ç‚¹ï¼Œä½¿ç”¨ä½é€‰æ‹©ä»£æ›¿ gatherã€‚
- æ­¥éª¤ï¼š
  1. å¯åŠ¨æ—¶åŠ è½½ depth2 å’Œ depth3 èŠ‚ç‚¹åˆ° scratchã€‚
  2. è®¡ç®— `bit0 bit1 bit2`ï¼Œç”¨ä¹˜åŠ æ„é€ é€‰æ‹©æ ‘ã€‚
  3. åœ¨å¯¹åº”è½®æ¬¡ç¦ç”¨ gatherã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart LR
  subgraph Before[Gather]
    B1[LoadOffset] --> B2[NodeVal]
  end
  subgraph After[SelectTree]
    A1[BitSelect] --> A2[NodeVal]
  end
```
- é¢„æœŸæ”¶ç›Šï¼š`load_offset` ä¸‹é™çº¦ 1024ï¼ŒL ä¸‹ç•Œé™è‡³ ~1070 cyclesã€‚

### 3) Hash å‹ç¼©ä¸åˆ†æ®µ LUT
- ä¼˜å…ˆçº§ï¼šğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šå°† hash æ‹†åˆ†ä¸ºä¸¤æ®µæŸ¥è¡¨ä¸å°‘é‡åˆå¹¶è¿ç®—ï¼Œå‡å°‘æ¯è½® valu æ“ä½œæ•°ã€‚
- æ­¥éª¤ï¼š
  1. è®¾è®¡ 12-bit LUT æ®µï¼Œå‡å°‘ 3 ä¸ª hash stageã€‚
  2. é€šè¿‡ XOR ä¸ add åˆå¹¶æ®µç»“æœï¼Œä¿æŒ 32-bit ä¸€è‡´æ€§ã€‚
  3. æµ‹é‡ LUT å¸¦æ¥çš„ load ä¸ valu æƒè¡¡ã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart LR
  subgraph Before[HashStages]
    B1[Stage1] --> B2[Stage2] --> B3[Stage3]
  end
  subgraph After[HashLut]
    A1[Lut] --> A2[Merge]
  end
```
- é¢„æœŸæ”¶ç›Šï¼švalu ä¸‹é™ 20 åˆ° 30 ç™¾åˆ†æ¯”ï¼Œç›®æ ‡ä¸‹ç•Œæ¥è¿‘ 1200ã€‚

## ä»£ç è‰æ¡ˆ
```python
# depth 0 idx update
parity = val & 1
idx = parity + 1

# depth10 wrap
if depth == forest_height:
    idx = idx if idx < n_nodes else 0

# depth2 select sketch
bit0 = offset & 1
bit1 = (offset >> 1) & 1
t0 = v0 + bit0 * d01
t1 = v2 + bit0 * d23
node = t0 + bit1 * (t1 - t0)
```

## æ ¡éªŒ
- `python tests/submission_tests.py` å¿…é¡»é€šè¿‡ã€‚
- trace ä¸­ `valu` æ€»é‡ä¸‹é™åˆ° 8756 å·¦å³ï¼Œ`load_offset` ç»´æŒæˆ–ä¸‹é™ã€‚

## é£é™©ä¸ç¼“è§£
- æ·±åº¦ç‰¹åŒ–è‹¥é”™è¯¯ä¼šç ´åè·¯å¾„ï¼šä½¿ç”¨ debug compare éªŒè¯æ¯è½®ä¸­é—´æ€ã€‚
- LUT å¯èƒ½å¼•å…¥ç­‰ä»·æ€§é£é™©ï¼šç”¨å‚è€ƒè¾“å‡ºé€è½®å¯¹æ¯”ã€‚
- scratch å‹åŠ›ä¸Šå‡ï¼šç”¨åˆ†å±‚åŠ è½½ä¸å¤ç”¨ temp é™ä½å‹åŠ›ã€‚

