# ä¼˜åŒ–æ–¹æ¡ˆ v0.6ï¼ˆä¸­æ–‡ï¼‰

## ç¬¬ä¸€æ€§åŸç†ä¸èµ„æºçº¦æŸ
- SIMD å‘é‡å®½åº¦ VLEN=8ã€‚
- å¼•æ“ä¸Šé™ï¼švalu 6 æ§½ï¼Œload 2 æ§½ï¼Œstore 2 æ§½ï¼Œflow 1 æ§½ã€‚
- Scratch 1536ï¼Œå¯å®¹çº³å¤šå¥—å‘é‡ç¼“å†²ä¸ä¸­é—´æ€ã€‚
- æ¯è½®å¿…é¡»è¯»å– node å€¼ï¼Œhash ä¸ idx æ›´æ–°ä¾èµ–ä¸Šä¸€è½®ç»“æœã€‚

## ç†è®ºä¸‹ç•Œä¸æ•°å­¦æ¨å¯¼
è®¾ B=VLEN=8ï¼ŒR=rounds=16ï¼ŒSload=2ï¼ŒSvalu=6ã€‚

- æ¯è½® gather è‡³å°‘éœ€è¦ B æ¬¡ load_offset  
  Cload >= ceil(B / Sload) = ceil(8/2) = 4 cycles

- æ¯è½® hash é“¾è·¯æ“ä½œæ•°è¿‘ä¼¼  
  Nh = 1 xor + 6 stages * 3 ops + 6 for idx æ›´æ–°ä¸å›ç»•  
  Nh ~= 25  
  Cvalu >= ceil(Nh / Svalu) = ceil(25/6) = 5 cycles

å› æ­¤å•è½®ç†è®ºä¸‹ç•Œçº¦ä¸º  
Cround >= max(Cload, Cvalu) = 5 cycles

è‹¥å°† 3 ä¸ªå¯èåˆé˜¶æ®µä» 3 ops åŒ–ç®€ä¸º 1 opï¼Œ  
Nh' ~= 19 => Cvalu' >= ceil(19/6) = 4 cycles  
åˆ™ Cround' ~= 4 cycles

å†…å­˜å¾€è¿”ä¸‹ç•Œ  
ç°çŠ¶ï¼šæ¯è½® vload + vstore  
å…¨è½®ï¼š4 * R æ¬¡å‘é‡å†…å­˜æ“ä½œ  
è‹¥è½®æ¬¡å†…å­˜é©»ç•™ï¼Œåˆ™å˜ä¸º 4 æ¬¡å‘é‡å†…å­˜æ“ä½œ  
æ¯”ä¾‹çº¦ä¸º R å€ä¸‹é™

## 1.0 ç³»ç»Ÿæ¶æ„è“å›¾
æ ¸å¿ƒæ€æƒ³ï¼šä»¥æ‰¹æ¬¡å—ä¸ºå•ä½é©»ç•™çŠ¶æ€ï¼Œè½®æ¬¡å†…è‡ªå¾ªç¯ï¼Œå‡å°‘å†…å­˜å¾€è¿”ï¼›åŒæ—¶ç”¨ç®—å­èåˆé™ä½ valu æŒ‡ä»¤å¯†åº¦ï¼›å†ä»¥åˆ†ç»„ gather è°ƒåº¦å¹³è¡¡ load å³°å€¼ã€‚

### ç³»ç»Ÿæ¶æ„å›¾
```mermaid
flowchart TB
  MEM["memory"]
  SCR["scratch"]
  SCH["scheduler"]
  GAT["gather"]
  HSH["hash"]
  IDX["idx update"]
  WR["writeback"]
  MEM --> SCR
  SCR --> GAT --> HSH --> IDX --> WR --> MEM
  SCH --> GAT
  SCH --> HSH
  SCH --> IDX
  SCH --> WR
```

### æµç¨‹å›¾
```mermaid
flowchart LR
  S0["load block"] --> S1["round loop in scratch"]
  S1 --> S2["gather node"]
  S2 --> S3["hash fused"]
  S3 --> S4["idx update"]
  S4 --> S1
  S1 --> S5["store block"]
```

### æ—¶åºå›¾
```mermaid
sequenceDiagram
  participant Load
  participant Hash
  participant Store
  Note over Load,Hash: "block k"
  Load->>Hash: "gather group 1"
  Hash->>Hash: "hash stage"
  Load->>Hash: "gather group 2"
  Hash->>Store: "commit"
```

### æ•°æ®æµç¨‹å›¾
```mermaid
flowchart LR
  D0["idx val"] --> D1["node gather"]
  D1 --> D2["hash"]
  D2 --> D3["next idx"]
  D3 --> D0
```

### èµ„æºå ç”¨é¥¼å›¾
```mermaid
pie
  title "engine budget"
  "load" : 35
  "valu" : 45
  "store" : 10
  "flow" : 5
  "alu" : 5
```

## æœ¬æ¬¡ä¼˜åŒ–è¦è§£å†³çš„é—®é¢˜
- è½®æ¬¡é—´ä¸å¿…è¦çš„å†…å­˜å¾€è¿”ã€‚
- hash é“¾è·¯ valu æŒ‡ä»¤å¯†åº¦è¿‡é«˜ã€‚
- load å³°å€¼é«˜äºä¸Šé™å¯¼è‡´æ‹¥å¡ã€‚

## ä¼˜åŒ–ç‚¹

### 1) è½®æ¬¡å†…å­˜é©»ç•™ä¸å¾ªç¯äº¤æ¢
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šæ‰¹æ¬¡å—é©»ç•™ scratchï¼Œå®Œæˆå…¨éƒ¨ rounds åå†å†™å›ã€‚
- æ­¥éª¤ï¼š
  1. ä»¥ VLEN æˆ– 2*VLEN ä¸ºå— vload idx ä¸ valã€‚
  2. åœ¨ scratch ä¸­å¾ªç¯æ‰§è¡Œ roundsã€‚
  3. ç»“æŸåä¸€æ¬¡æ€§ vstoreã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart TB
  subgraph Before["round driven"]
    B1["vload"] --> B2["round work"] --> B3["vstore"]
  end
  subgraph After["block driven"]
    A1["vload"] --> A2["round loop"] --> A3["vstore"]
  end
```

### 2) Hash ç®—å­èåˆåˆ° multiply_add
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šå°†åŠ å¸¸é‡ä¸å·¦ç§»ç›¸åŠ çš„ä¸‰æ­¥é“¾è·¯å‹ç¼©ä¸ºä¸€æ¬¡ä¹˜åŠ ã€‚
- æ­¥éª¤ï¼š
  1. è¯†åˆ« op2 ä¸ºåŠ æ³•ä¸” op3 ä¸ºå·¦ç§»çš„é˜¶æ®µã€‚
  2. é¢„è®¡ç®—ä¹˜æ•°å¸¸é‡å¹¶ vbroadcastã€‚
  3. ç”¨ multiply_add ä»£æ›¿ä¸‰æ¡ valu æŒ‡ä»¤ã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart LR
  subgraph Before["3 ops"]
    B1["add"] --> B2["shift"] --> B3["add"]
  end
  subgraph After["1 op"]
    A1["mul add"]
  end
```

### 3) åˆ†ç»„ gather è°ƒåº¦
- ä¼˜å…ˆçº§ï¼šğŸŒŸğŸŒŸğŸŒŸ
- æ ¸å¿ƒæ€æƒ³ï¼šå°† VLEN lane åˆ†ç»„äº¤é”™ï¼Œé¿å…å•å‘¨æœŸ load è¶…é™ã€‚
- æ­¥éª¤ï¼š
  1. å°† lane åˆ†ä¸¤ç»„æˆ–å››ç»„ã€‚
  2. ç»„é—´æ’å…¥ hash é˜¶æ®µã€‚
  3. ä»¥åŒ…çº§è°ƒåº¦é™åˆ¶ load å³°å€¼ã€‚
- æ”¹è¿›å‰åå›¾è¡¨ï¼š
```mermaid
flowchart TB
  subgraph Before["full gather"]
    B1["load group all"] --> B2["hash"]
  end
  subgraph After["grouped gather"]
    A1["load group a"] --> A2["hash"]
    A3["load group b"] --> A4["hash"]
    A2 -. parallel .- A3
  end
```

## ä»£ç è‰æ¡ˆ
```python
for block in blocks:
    vload idx, val
    for r in range(rounds):
        gather node in groups
        val = hash_fused(val ^ node)
        idx = next_idx(val, idx)
    vstore idx, val
```

## æ ¡éªŒ
- `python tests/submission_tests.py` å¿…é¡»é€šè¿‡ã€‚
- é€šè¿‡ trace éªŒè¯å†…å­˜å¾€è¿”å‡å°‘ä¸ load å³°å€¼ä¸‹é™ã€‚

## é£é™©ä¸ç¼“è§£
- å¾ªç¯äº¤æ¢å¿…é¡»ä¿æŒè¯­ä¹‰ä¸€è‡´ï¼Œç¡®ä¿æ¯è½®ä¾èµ–æ­£ç¡®ã€‚
- ç®—å­èåˆéœ€ä¿æŒæ¨¡ 2^32 è¡Œä¸ºä¸€è‡´ã€‚
- åˆ†ç»„ gather å¯èƒ½å¢åŠ æ§åˆ¶å¤æ‚åº¦ï¼Œå…ˆä¿å®ˆåˆ†ç»„ã€‚

## å¾…å®¡æ ¸
- æœ¬ç‰ˆæœ¬ä¸ºè®¡åˆ’è‰æ¡ˆï¼Œç­‰å¾…äººå·¥å®¡æ ¸åè¿›å…¥å®ç°ä¸æµ‹é‡é˜¶æ®µã€‚
