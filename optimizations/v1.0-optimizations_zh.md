# 优化方案 v1.0（中文）

## 目标
- 在不修改 `tests/` 的前提下优化 cycles。
- 目标值：1200 cycles（作为理论目标）。
- 本轮实现：VLIW 调度器升级 + 分组调参，实测约 1796 cycles。

## 理论下界与推导
指令周期下界满足：
```
cycles >= max(ceil(L/2), ceil(V/6), ceil(S/2))
```
其中：
- `L` 为 load slot 数
- `V` 为 valu slot 数
- `S` 为 store slot 数

当前统计（v1.0 调度后）：
- `L ≈ 2658`
- `V ≈ 9147`
- `S ≈ 32`

下界约：
```
max(1329, 1525, 16) = 1525
```
这意味着仅靠调度无法到达 1200，若要接近 1200，必须降低 `L` 与 `V` 的总量。

## 架构设计（VLIW 调度器）
核心思路：将 `build()` 的贪心打包替换为“依赖图 + 列表调度”。

### 依赖建模
- RAW：写 -> 读（必须在后续周期）
- WAW：写 -> 写（必须在后续周期）
- WAR：读 -> 写（允许同周期，但不能越序）

### 调度策略
- 构建依赖图（RAW/WAW 为硬依赖）。
- 维护 ready 队列并按 slot 限制填充每个周期。
- 每周期内允许满足 WAR 的写入与读指令同周期出现（写不再阻塞同周期 read）。
- 使用关键路径 rank 做列表调度，并在同 rank 下按引擎优先级（load → valu → alu → store → flow）排序。
- 调整 `pipe` 到 13，增加可并行块数，提高 VALU 利用率。
- `debug` slot 视作屏障，强制分段调度。

### 收益
相对于贪心打包：
- load-only 周期显著减少（~558 降至 ~66）
- 平均 VALU 利用率提升（~3.8 -> ~5.13 / cycle）
- 总周期从 ~2402 降至 ~1796

## 代码实现
核心变更：
- 新增 `_schedule_segment()`：依赖图 + 列表调度
- `build()` 使用调度器替代贪心打包

位置：
- `source_repo/perf_takehome.py`

## 结果
```
forest_height=10, rounds=16, batch_size=256
CYCLES: 1796
```

## 与 1200 目标的差距
达到 1200 需要：
- `L <= 2400`
- `V <= 7200`

目前仍需算法级缩减 load 与 hash 负载，例如：
1) 深度特化（depth3/4 预加载）减少 gather load；
2) Hash 链路压缩（精确 LUT 或分段融合）降低 valu 数量。

这些需要更复杂的等价变换与 scratch 规划，且需额外验证正确性。
