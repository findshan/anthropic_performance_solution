# v3.0 Architecture Documentation

## Overview
The v3.0 Architecture introduces a "Wave-Based" scheduling approach and optimized vector operations to significantly reduce cycle count.

## Key Features

### 1. Scheduler 3.0 (Wave-Based)
- **Concept**: Instead of scheduling all operations for vector 0, then vector 1, etc., we schedule "waves" of similar operations across all vectors.
- **Benefit**: This maximizes utilization of specific functional units (like VALU) that have high throughput but limited slots per cycle. By grouping VALU ops from multiple vectors, we can fill the 6 VALU slots more consistently.
- **Implementation**: The `schedule_ops` function has been rewritten to prioritize filling bundles with operations of the same type from different instruction streams.

### 2. Vectorized 6-Stage Hash
- The hash function is fully vectorized.
- Operations are grouped to allow `multiply_add` fusion where possible.
- Constants are broadcasted efficiently.

### 3. Depth-Based Logic
- **Depth 0-2**: Optimized handling for the top of the tree using `vselect` and logical operations to avoid memory access latency.
- **Depth 3+**: Uses `load_offset` for dynamic memory access.

### 4. Parallel Pointer Arithmetic
- Pointer updates (`idx_ptr`, `val_ptr`) are calculated in parallel using the 12 ALU slots, reducing the overhead of loop index management.

## Performance
- **Current Benchmark**: ~1425 cycles (Forest Height 10, Rounds 16, Batch 256).
- **Bottlenecks**: Trace analysis shows high VALU and Load utilization, indicating these are the primary limiting factors.

## Future Improvements (Planned)
- **Depth 3 Optimization**: Moving Depth 3 nodes from memory loads to `vselect` logic to trade Load pressure for Flow/ALU pressure.
- **ALU Offloading**: Using ALU for simple bitwise operations to relieve VALU pressure.
